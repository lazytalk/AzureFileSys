<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit User Data Record</title>
    ~[wc:commonscripts] 
    <link href="/images/css/screen.css" rel="stylesheet" media="screen">
    <link href="/images/css/print.css" rel="stylesheet" media="print">
    <style>
      .kwe_ud_row{margin:10px 0}
      label{display:inline-block;width:200px;vertical-align:top}
      input[type=text], input[type=number], input[type=date], textarea{width:420px;padding:6px}
      textarea{height:90px}
      .kwe_ud_btn{padding:6px 10px;border:1px solid #aaa;background:#f7f7f7;border-radius:4px;cursor:pointer}
      .kwe_ud_box{padding:12px;border:1px solid #ddd;background:#fafafa;margin:10px 0}
      .kwe_ud_hint{color:#666;font-size:12px}
    </style>
</head>
<body>
    ~[wc:admin_header_css] 
    <a href="/" target="_top">Start Page</a> &gt; File Service Tools
    ~[wc:admin_navigation_css]

<!-- Load record using DirectTable -->
~[DirectTable.Select:U_UD_RECORD;ID:~(gpv.recid)]

    <h1>Edit Record</h1>

    <p>
      <a class="kwe_ud_btn" href="userdata-list.html?usersdcid=~(gpv.usersdcid)&catid=~(gpv.catid)&page=~(gpv.page)&q=~(gpv.q)">‚Üê Back to List</a>
    </p>

    <form action="userdata-save.html" method="GET">
  
  <!-- Pass context parameters -->
  <input type="hidden" name="usersdcid" value="~(gpv.usersdcid)">
  <input type="hidden" name="catid" value="~(gpv.catid)">
  <input type="hidden" name="recid" value="~(gpv.recid)">
  <input type="hidden" name="page" value="~(gpv.page)">
  <input type="hidden" name="q" value="~(gpv.q)">
  <input type="hidden" name="save_values" value="1">

  <!-- Dynamically render field inputs by joining fielddef with existing values -->
  <div style="background:cyan;padding:10px;margin-bottom:10px;">
    DEBUG: Field rendering test<br>
    <script>
      document.write('JavaScript is working<br>');
      document.write('Number of field wrappers found: ' + document.querySelectorAll('.kwe_ud_field_wrapper').length);
    </script>
  </div>
  
  ~[tlist_sql;
    SELECT
      f.ID fid,
      f.FIELD_LABEL || CASE WHEN f.REQUIRED = 1 THEN ' *' ELSE '' END AS flabel,
      f.VALUE_TYPE ftype,
      f.HELP_TEXT fhelp,
      NVL((SELECT v.VALUE_STR FROM U_UD_VALUE v WHERE v.RECORD_ID = ~(gpv.recid) AND v.FIELDDEF_ID = f.ID), '') vstr,
      NVL(TO_CHAR((SELECT v.VALUE_NUM FROM U_UD_VALUE v WHERE v.RECORD_ID = ~(gpv.recid) AND v.FIELDDEF_ID = f.ID)), '') vnum,
      NVL(TO_CHAR((SELECT v.VALUE_DATE FROM U_UD_VALUE v WHERE v.RECORD_ID = ~(gpv.recid) AND v.FIELDDEF_ID = f.ID), 'YYYY-MM-DD'), '') vdate,
      NVL((SELECT v.VALUE_BOOL FROM U_UD_VALUE v WHERE v.RECORD_ID = ~(gpv.recid) AND v.FIELDDEF_ID = f.ID), 0) vbool,
      NVL((SELECT v.VALUE_TEXT FROM U_UD_VALUE v WHERE v.RECORD_ID = ~(gpv.recid) AND v.FIELDDEF_ID = f.ID), '') vtext
    FROM U_UD_FIELDDEF f
    WHERE f.CATEGORY_ID = ~(gpv.catid)
    ORDER BY NVL(f.SORT_ORDER,9999), UPPER(f.FIELD_LABEL)
  ]
    <div class="kwe_ud_box">
      <div class="kwe_ud_row">
        <label>[ID: ~(fid)] ~(flabel) </label>
        <span class="kwe_ud_field_wrapper" data-fid="~(fid)" data-ftype="~(ftype)" data-vstr="~(vstr)" data-vnum="~(vnum)" data-vdate="~(vdate)" data-vbool="~(vbool)" data-vtext="~(vtext)">
          <!-- Direct test: ~(fid) -->
        </span>
        <div style="font-size:10px;color:#999;margin-left:200px;">
          Debug: fid=~(fid), ftype=~(ftype)<br>
          <script>
            var wrapper = document.currentScript.previousElementSibling.previousElementSibling;
            document.write('JS reads data-fid as: "' + wrapper.getAttribute('data-fid') + '"');
          </script>
        </div>
      </div>
      ~[if#help.~(fhelp)!=]<div class="kwe_ud_hint" style="margin-left:200px">~(fhelp)</div>[/if#help]
    </div>
  [/tlist_sql]

  <script>
    // Build all input fields via JavaScript to avoid PowerSchool template variable scoping issues
    document.querySelectorAll('.kwe_ud_field_wrapper').forEach(function(wrapper) {
      var fieldId = wrapper.getAttribute('data-fid');
      var fieldType = wrapper.getAttribute('data-ftype');
      var valueStr = wrapper.getAttribute('data-vstr');
      var valueNum = wrapper.getAttribute('data-vnum');
      var valueDate = wrapper.getAttribute('data-vdate');
      var valueBool = wrapper.getAttribute('data-vbool');
      var valueText = wrapper.getAttribute('data-vtext');
      
      var input;
      
      if (fieldType === 'TEXT') {
        input = document.createElement('textarea');
        input.value = valueText || '';
        input.style.width = '420px';
        input.style.height = '90px';
      } else if (fieldType === 'BOOL') {
        input = document.createElement('input');
        input.type = 'checkbox';
        input.value = '1';
        if (valueBool === '1') {
          input.checked = true;
        }
      } else if (fieldType === 'STRING') {
        input = document.createElement('input');
        input.type = 'text';
        input.value = valueStr || '';
      } else if (fieldType === 'INT') {
        input = document.createElement('input');
        input.type = 'number';
        input.step = '1';
        input.value = valueNum || '';
      } else if (fieldType === 'DECIMAL') {
        input = document.createElement('input');
        input.type = 'number';
        input.step = '0.01';
        input.value = valueNum || '';
      } else if (fieldType === 'DATE') {
        input = document.createElement('input');
        input.type = 'date';
        input.value = valueDate || '';
      } else {
        input = document.createElement('input');
        input.type = 'text';
        input.value = valueStr || '';
      }
      
      input.name = 'fld_' + fieldId;
      
      // Add console log to debug non-breaking space issue
      if (input.value && input.value.charCodeAt(0) === 160) {
        console.warn('Field ' + fieldId + ' has non-breaking space at start');
        input.value = input.value.trim().replace(/\u00A0/g, ' '); // Remove non-breaking spaces
      }
      
      wrapper.appendChild(input);
    });
  </script>

  <div class="kwe_ud_row">
    <button class="kwe_ud_btn" type="submit">Save</button>
  </div>

</form>


</body>
</html>
