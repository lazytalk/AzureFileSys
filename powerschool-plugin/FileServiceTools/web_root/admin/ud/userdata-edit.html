<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit User Data Record</title>
    ~[wc:commonscripts] 
    <link href="/images/css/screen.css" rel="stylesheet" media="screen">
    <link href="/images/css/print.css" rel="stylesheet" media="print">
    <style>
      body { font-family: Arial, sans-serif; }
      .kwe_ud_row { margin: 10px 0; }
      .kwe_ud_field_row { padding: 10px 0; border-bottom: 1px solid #eee; }
      label { display: inline-block; width: 200px; vertical-align: top; font-weight: bold; }
      input[type=text], input[type=number], input[type=date], textarea { width: 420px; padding: 6px; }
      textarea { height: 90px; }
      .kwe_ud_btn { padding: 6px 10px; border: 1px solid #aaa; background: #f7f7f7; border-radius: 4px; cursor: pointer; text-decoration: none; color: #333; display: inline-block; }
      .kwe_ud_btn:hover { background: #e7e7e7; }
      .kwe_ud_btn-primary { background: #0078d4; color: white; border: 1px solid #0078d4; }
      .kwe_ud_btn-primary:hover { background: #106ebe; }
      .kwe_ud_hint { color: #666; font-size: 12px; margin-left: 200px; margin-top: 4px; }
      .kwe_ud_required { color: red; }
      .kwe_ud_actions { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; }
    </style>
</head>
<body>
    ~[wc:admin_header_css] 
    <a href="/" target="_top">Start Page</a> &gt; File Service Tools
    ~[wc:admin_navigation_css]

    <h1>Edit Record</h1>

    <p>
      <a class="kwe_ud_btn" href="userdata-list.html?usersdcid=~(gpv.usersdcid)&catid=~(gpv.catid)&page=~(gpv.page)&q=~(gpv.q)">‚Üê Back to List</a>
    </p>

    <div style="background:#f0f0f0;padding:10px;margin:10px 0;font-size:12px;">
      <strong>Debug:</strong> recid=~(gpv.recid), catid=~(gpv.catid), usersdcid=~(gpv.usersdcid)
    </div>

    <!-- Container for all field forms -->
    <div id="formsContainer">
      ~[tlist_sql;
        SELECT
          f.ID fielddef_id,
          f.FIELD_LABEL flabel,
          f.REQUIRED freq,
          CASE WHEN v.ID IS NULL THEN -1 ELSE v.ID END value_id,
          ~(gpv.recid) record_id,
          CASE f.VALUE_TYPE
            WHEN 'TEXT' THEN
              TO_CLOB('<textarea name="') 
            WHEN 'BOOL' THEN
              TO_CLOB('<input type="hidden" name="') || 'CF-' || chr(91) || chr(58) || '0.U_UD_UserData.U_UD_VALUE'|| chr(58) || CASE WHEN v.ID IS NULL THEN -1 ELSE v.ID END || chr(93) || TO_CLOB('VALUE_BOOL" value=""><input type="checkbox" name="') 
            WHEN 'INT' THEN
              TO_CLOB('<input type="number" name="') 
            WHEN 'DECIMAL' THEN
              TO_CLOB('<input type="number" name="') 
            WHEN 'DATE' THEN
              TO_CLOB('<input type="date" name="') 
            ELSE
              TO_CLOB('<input type="text" name="') 
          END || 'CF-' || chr(91) || chr(58) || '0.U_UD_UserData.U_UD_VALUE'|| chr(58) || CASE WHEN v.ID IS NULL THEN -1 ELSE v.ID END || chr(93) controltype,

          CASE f.VALUE_TYPE
            WHEN 'TEXT' THEN
              TO_CLOB('VALUE_TEXT">') ||
              NVL(v.VALUE_TEXT, TO_CLOB('')) ||
              TO_CLOB('</textarea>')
            WHEN 'BOOL' THEN
              TO_CLOB('VALUE_BOOL" value="1') ||
              CASE WHEN NVL(v.VALUE_BOOL, 0) = 1 THEN '" checked="checked' ELSE '' END ||
              TO_CLOB('">')
            WHEN 'INT' THEN
              TO_CLOB('VALUE_NUM$format=numeric" step="1" value="') ||
              TO_CLOB(NVL(TO_CHAR(v.VALUE_NUM), '')) ||
              TO_CLOB('">')
            WHEN 'DECIMAL' THEN
              TO_CLOB('VALUE_NUM$format=numeric" step="0.01" value="') ||
              TO_CLOB(NVL(TO_CHAR(v.VALUE_NUM), '')) ||
              TO_CLOB('">')
            WHEN 'DATE' THEN
              TO_CLOB('VALUE_DATE$format=date" value="') ||
              TO_CLOB(NVL(TO_CHAR(v.VALUE_DATE, 'YYYY-MM-DD'), '')) ||
              TO_CLOB('">')
            ELSE
              TO_CLOB('VALUE_STR" value="') ||
              TO_CLOB(NVL(v.VALUE_STR, '')) ||
              TO_CLOB('">')
          END fieldvaluewithend,
          f.HELP_TEXT fhelp
        FROM U_UD_FIELDDEF f
        LEFT JOIN U_UD_VALUE v ON v.FIELDDEF_ID = f.ID AND v.RECORD_ID = ~(gpv.recid)
        WHERE f.CATEGORY_ID = ~(gpv.catid)
        ORDER BY NVL(f.SORT_ORDER, 9999), UPPER(f.FIELD_LABEL)
      ]
        <form method="POST" action="/admin/changesrecorded.white.html" class="fieldForm" id="form-~(fielddef_id)" style="margin-bottom: 0;">
          <input type="hidden" name="ac" value="prim">
          <div class="kwe_ud_field_row">
            <label>~(flabel) ~[if#req.~(freq)=1]<span class="kwe_ud_required">*</span>[/if#req]</label>
            <input type="hidden" name="CF-[:0.U_UD_UserData.U_UD_VALUE:~(value_id)]FIELDDEF_ID$formatnumeric=###########.#####" value="~(fielddef_id)">
            <input type="hidden" name="CF-[:0.U_UD_UserData.U_UD_VALUE:~(value_id)]RECORD_ID$formatnumeric=###########.#####" value="~(record_id)">
            <input type="hidden" name="CF-[:0.U_UD_UserData.U_UD_VALUE:~(value_id)]CREATED_ON$format=date" value="">
            <input type="hidden" name="CF-[:0.U_UD_UserData.U_UD_VALUE:~(value_id)]CREATED_BY" value="">
            <input type="hidden" name="CF-[:0.U_UD_UserData.U_UD_VALUE:~(value_id)]UPDATED_ON$format=date" value="">
            <input type="hidden" name="CF-[:0.U_UD_UserData.U_UD_VALUE:~(value_id)]UPDATED_BY" value="">
            ~(controltype)~(fieldvaluewithend)
            ~[if#help.~(fhelp)!=]<div class="kwe_ud_hint">~(fhelp)</div>[/if#help]
          </div>
        </form>
      [/tlist_sql]
    </div>

    <div class="kwe_ud_actions">
      <button type="button" class="kwe_ud_btn kwe_ud_btn-primary" onclick="submitAllForms()">Save Changes</button>
      <a class="kwe_ud_btn" href="userdata-list.html?usersdcid=~(gpv.usersdcid)&catid=~(gpv.catid)&page=~(gpv.page)&q=~(gpv.q)">Cancel</a>
    </div>

    <script>
      function submitAllForms() {
        // Get all field forms
        const forms = document.querySelectorAll('.fieldForm');
        
        if (forms.length === 0) {
          alert('No forms found to submit');
          return;
        }

        // Submit forms one by one
        let formIndex = 0;

        function submitNextForm() {
          if (formIndex >= forms.length) {
            // All forms submitted successfully, redirect to list page
            const usersdcid = '~(gpv.usersdcid)';
            const catid = '~(gpv.catid)';
            const page = '~(gpv.page)';
            const q = '~(gpv.q)';
            const returnURL = 'userdata-list.html?usersdcid=' + encodeURIComponent(usersdcid) + '&catid=' + encodeURIComponent(catid) + '&page=' + encodeURIComponent(page) + '&q=' + encodeURIComponent(q);
            window.location.href = returnURL;
            return;
          }

          const form = forms[formIndex];
          const formData = new FormData(form);
          const action = form.action;

          // Submit this form via fetch
          fetch(action, {
            method: 'POST',
            body: formData
          })
          .then(response => {
            // Move to next form after successful submission
            formIndex++;
            submitNextForm();
          })
          .catch(error => {
            console.error('Error saving form ' + (formIndex + 1) + ':', error);
            alert('Error saving form ' + (formIndex + 1) + '. Please try again.');
          });
        }

        // Start submitting forms
        submitNextForm();
      }
    </script>

</body>
</html>
