<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit User Data Record</title>
    ~[wc:commonscripts] 
    <link href="/images/css/screen.css" rel="stylesheet" media="screen">
    <link href="/images/css/print.css" rel="stylesheet" media="print">
    <style>
      body { font-family: Arial, sans-serif; }
      .kwe_ud_row { margin: 10px 0; }
      .kwe_ud_field_row { padding: 10px 0; border-bottom: 1px solid #eee; }
      label { display: inline-block; width: 200px; vertical-align: top; font-weight: bold; }
      input[type=text], input[type=number], input[type=date], textarea { width: 420px; padding: 6px; }
      textarea { height: 90px; }
      .kwe_ud_btn { padding: 6px 10px; border: 1px solid #aaa; background: #f7f7f7; border-radius: 4px; cursor: pointer; text-decoration: none; color: #333; display: inline-block; }
      .kwe_ud_btn:hover { background: #e7e7e7; }
      .kwe_ud_btn-primary { background: #0078d4; color: white; border: 1px solid #0078d4; }
      .kwe_ud_btn-primary:hover { background: #106ebe; }
      .kwe_ud_hint { color: #666; font-size: 12px; margin-left: 200px; margin-top: 4px; }
      .kwe_ud_required { color: red; }
      .kwe_ud_actions { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; }
    </style>
</head>
<body>
    ~[wc:admin_header_css] 
    <a href="/" target="_top">Start Page</a> &gt; File Service Tools
    ~[wc:admin_navigation_css]

    ~[DirectTable.Select:U_UD_RECORD;ID:~(gpv.recid)]

    <h1>Edit Record</h1>

    <p>
      <a class="kwe_ud_btn" href="userdata-list.html?usersdcid=~(gpv.usersdcid)&catid=~(gpv.catid)&page=~(gpv.page)&q=~(gpv.q)">‚Üê Back to List</a>
    </p>

    <form method="POST" action="/admin/changesrecorded.white.html">
      <input type="hidden" name="usersdcid" value="~(gpv.usersdcid)">
      <input type="hidden" name="catid" value="~(gpv.catid)">
      <input type="hidden" name="recid" value="~(gpv.recid)">
      <input type="hidden" name="page" value="~(gpv.page)">
      <input type="hidden" name="q" value="~(gpv.q)">
      <input type="hidden" name="ac" value="prim">

      <div style="background:#f0f0f0;padding:10px;margin:10px 0;font-size:12px;">
        <strong>Debug:</strong> recid=~(gpv.recid), catid=~(gpv.catid), usersdcid=~(gpv.usersdcid)
      </div>

      ~[tlist_sql;
        SELECT
          f.FIELD_LABEL flabel,
          f.REQUIRED freq,
          f.ID fid,
          f.VALUE_TYPE ftype,
          '' vid,
          '' vstr,
          '' vnum,
          '' vdate,
          0 vbool,
          '' vtext,
          f.HELP_TEXT fhelp
        FROM U_UD_FIELDDEF f
        WHERE f.CATEGORY_ID = ~(gpv.catid)
        ORDER BY NVL(f.SORT_ORDER, 9999), UPPER(f.FIELD_LABEL)
      ]
        <div class="kwe_ud_field_row">
          <label>
            ~(flabel)
            ~[if#req.~(freq)=1]<span class="kwe_ud_required">*</span>[/if#req]
          </label>
          
          <span class="kwe_ud_field_wrapper" 
            data-fid="~(fid)" 
            data-ftype="~(ftype)" 
            data-vid="~(vid)"
            data-vstr="~(vstr)" 
            data-vnum="~(vnum)" 
            data-vdate="~(vdate)" 
            data-vbool="~(vbool)" 
            data-vtext="~(vtext)">
          </span>

          ~[if#help.~(fhelp)!=]
            <div class="kwe_ud_hint">~(fhelp)</div>
          [/if#help]
        </div>
      [/tlist_sql]

      <div class="kwe_ud_actions">
        <button type="submit" class="kwe_ud_btn kwe_ud_btn-primary">Save Changes</button>
        <a class="kwe_ud_btn" href="userdata-list.html?usersdcid=~(gpv.usersdcid)&catid=~(gpv.catid)&page=~(gpv.page)&q=~(gpv.q)">Cancel</a>
      </div>
    </form>

    <script>
    // PowerSchool CF- naming (standalone): CF-[:0.U_UD_UserData.U_UD_VALUE:valueid]FIELDNAME
    
    document.querySelectorAll('.kwe_ud_field_wrapper').forEach(function(wrapper) {
      var fieldId = wrapper.getAttribute('data-fid');
      var valueId = wrapper.getAttribute('data-vid');
      var fieldType = wrapper.getAttribute('data-ftype');
      var valueStr = wrapper.getAttribute('data-vstr');
      var valueNum = wrapper.getAttribute('data-vnum');
      var valueDate = wrapper.getAttribute('data-vdate');
      var valueBool = wrapper.getAttribute('data-vbool');
      var valueText = wrapper.getAttribute('data-vtext');
      var recordId = document.querySelector('input[name="recid"]').value;

      // Build CF- field name: if valueId exists (update), use it; otherwise use -1 (insert)
      var valueRecordId = (valueId && valueId.trim() && valueId !== ' ') ? valueId : '-1';
      var cfPrefix = 'CF-[:0.U_UD_UserData.U_UD_VALUE:' + valueRecordId + ']';

      // Hidden field for FIELDDEF_ID (required foreign key)
      var hiddenFieldDef = document.createElement('input');
      hiddenFieldDef.type = 'hidden';
      hiddenFieldDef.name = cfPrefix + 'FIELDDEF_ID';
      hiddenFieldDef.value = fieldId;
      wrapper.appendChild(hiddenFieldDef);

      // Hidden field for RECORD_ID (link back to U_UD_RECORD)
      var hiddenRecordId = document.createElement('input');
      hiddenRecordId.type = 'hidden';
      hiddenRecordId.name = cfPrefix + 'RECORD_ID';
      hiddenRecordId.value = recordId;
      wrapper.appendChild(hiddenRecordId);

      var input;

      // Create input based on field type
      if (fieldType === 'TEXT') {
        input = document.createElement('textarea');
        input.value = valueText || '';
        input.name = cfPrefix + 'VALUE_TEXT';
      } else if (fieldType === 'BOOL') {
        var hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = cfPrefix + 'VALUE_BOOL';
        hidden.value = '0';
        wrapper.appendChild(hidden);

        input = document.createElement('input');
        input.type = 'checkbox';
        input.value = '1';
        input.name = cfPrefix + 'VALUE_BOOL';
        if (valueBool === '1' || valueBool === 1) {
          input.checked = true;
        }
      } else if (fieldType === 'STRING') {
        input = document.createElement('input');
        input.type = 'text';
        input.value = valueStr || '';
        input.name = cfPrefix + 'VALUE_STR';
      } else if (fieldType === 'INT') {
        input = document.createElement('input');
        input.type = 'number';
        input.step = '1';
        input.value = valueNum || '';
        input.name = cfPrefix + 'VALUE_NUM';
      } else if (fieldType === 'DECIMAL') {
        input = document.createElement('input');
        input.type = 'number';
        input.step = '0.01';
        input.value = valueNum || '';
        input.name = cfPrefix + 'VALUE_NUM';
      } else if (fieldType === 'DATE') {
        input = document.createElement('input');
        input.type = 'date';
        input.value = valueDate || '';
        input.name = cfPrefix + 'VALUE_DATE';
      } else {
        input = document.createElement('input');
        input.type = 'text';
        input.value = valueStr || '';
        input.name = cfPrefix + 'VALUE_STR';
      }

      // Clean non-breaking spaces
      if (input.value && input.value.charCodeAt(0) === 160) {
        input.value = input.value.trim().replace(/\u00A0/g, ' ');
      }

      wrapper.appendChild(input);
    });
    </script>

</body>
</html>
