<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit User Data Record</title>
    ~[wc:commonscripts] 
    <link href="/images/css/screen.css" rel="stylesheet" media="screen">
    <link href="/images/css/print.css" rel="stylesheet" media="print">
    <style>
      .kwe_ud_row{margin:10px 0}
      label{display:inline-block;width:200px;vertical-align:top}
      input[type=text], input[type=number], input[type=date], textarea{width:420px;padding:6px}
      textarea{height:90px}
      .kwe_ud_btn{padding:6px 10px;border:1px solid #aaa;background:#f7f7f7;border-radius:4px;cursor:pointer}
      .kwe_ud_box{padding:12px;border:1px solid #ddd;background:#fafafa;margin:10px 0}
      .kwe_ud_hint{color:#666;font-size:12px}
    </style>
</head>
<body>
    ~[wc:admin_header_css] 
    <a href="/" target="_top">Start Page</a> &gt; File Service Tools
    ~[wc:admin_navigation_css]
    <h1>Edit Record</h1>

    <p>
      <a class="kwe_ud_btn" href="userdata-list.html?usersdcid=~(gpv.usersdcid)&catid=~(gpv.catid)&page=~(gpv.page)&q=~(gpv.q)">‚Üê Back to List</a>
    </p>

    <form action="userdata-list.html?usersdcid=~(gpv.usersdcid)&catid=~(gpv.catid)&page=~(gpv.page)&q=~(gpv.q)" method="POST">
  ~[DirectTable.Select:U_UD_RECORD;ID:~(gpv.recid)]

  <input type="hidden" name="[U_UD_RECORD]USERSDCID" value="~(gpv.usersdcid)">
  <input type="hidden" name="[U_UD_RECORD]CATEGORY_ID" value="~(gpv.catid)">

  <div class="kwe_ud_box">
    <div class="kwe_ud_row">
      <label>User DCID</label>
      <span>~(gpv.usersdcid)</span>
    </div>
    <div class="kwe_ud_row">
      <label>Category</label>
      <span>~(gpv.catid)</span>
    </div>
  </div>

  <h2>Fields</h2>

  <!-- Render fielddefs; for each, find existing value row (if any) -->
  ~[tlist_sql;
    SELECT
      f.ID fielddef_id,
      f.FIELD_LABEL field_label,
      f.VALUE_TYPE value_type,
      f.REQUIRED required,
      f.HELP_TEXT help_text,
      (
        SELECT v.ID
        FROM U_UD_VALUE v
        WHERE v.RECORD_ID = ~(gpv.recid)
          AND v.FIELDDEF_ID = f.ID
        FETCH FIRST 1 ROWS ONLY
      ) value_id,
      (
        SELECT v.VALUE_STR FROM U_UD_VALUE v WHERE v.ID = (
          SELECT v2.ID FROM U_UD_VALUE v2
          WHERE v2.RECORD_ID = ~(gpv.recid) AND v2.FIELDDEF_ID = f.ID
          FETCH FIRST 1 ROWS ONLY
        )
      ) value_str,
      (
        SELECT TO_CHAR(v.VALUE_NUM) FROM U_UD_VALUE v WHERE v.ID = (
          SELECT v2.ID FROM U_UD_VALUE v2
          WHERE v2.RECORD_ID = ~(gpv.recid) AND v2.FIELDDEF_ID = f.ID
          FETCH FIRST 1 ROWS ONLY
        )
      ) value_num,
      (
        SELECT TO_CHAR(v.VALUE_DATE,'YYYY-MM-DD') FROM U_UD_VALUE v WHERE v.ID = (
          SELECT v2.ID FROM U_UD_VALUE v2
          WHERE v2.RECORD_ID = ~(gpv.recid) AND v2.FIELDDEF_ID = f.ID
          FETCH FIRST 1 ROWS ONLY
        )
      ) value_date,
      (
        SELECT TO_CHAR(v.VALUE_BOOL) FROM U_UD_VALUE v WHERE v.ID = (
          SELECT v2.ID FROM U_UD_VALUE v2
          WHERE v2.RECORD_ID = ~(gpv.recid) AND v2.FIELDDEF_ID = f.ID
          FETCH FIRST 1 ROWS ONLY
        )
      ) value_bool,
      (
        SELECT v.VALUE_TEXT FROM U_UD_VALUE v WHERE v.ID = (
          SELECT v2.ID FROM U_UD_VALUE v2
          WHERE v2.RECORD_ID = ~(gpv.recid) AND v2.FIELDDEF_ID = f.ID
          FETCH FIRST 1 ROWS ONLY
        )
      ) value_text
    FROM U_UD_FIELDDEF f
    WHERE f.CATEGORY_ID = ~(gpv.catid)
    ORDER BY NVL(f.SORT_ORDER,9999), UPPER(f.FIELD_LABEL)
  ]
    <div class="kwe_ud_box">
      <div class="kwe_ud_row">
        <label>~(field_label) ~[if#req.~(required)=1]*[/if#req]</label>

        <!-- If an existing value row exists, edit it; else create one -->
        ~[if#hasVal.~(value_id)!=]
          ~[DirectTable.Select:U_UD_VALUE;ID:~(value_id)]
        [else#hasVal]
          ~[DirectTable.Select:U_UD_VALUE;ID:-1]
          <input type="hidden" name="[U_UD_VALUE]RECORD_ID" value="~(gpv.recid)">
          <input type="hidden" name="[U_UD_VALUE]FIELDDEF_ID" value="~(fielddef_id)">
        [/if#hasVal]

        <!-- Typed input -->
        ~[if#tstr.~(value_type)=STRING]
          <input type="text" name="[U_UD_VALUE]VALUE_STR" value="~(value_str)">
        [/if#tstr]

        ~[if#tint.~(value_type)=INT]
          <input type="number" step="1" name="[U_UD_VALUE]VALUE_NUM" value="~(value_num)">
        [/if#tint]

        ~[if#tdec.~(value_type)=DECIMAL]
          <input type="number" step="0.01" name="[U_UD_VALUE]VALUE_NUM" value="~(value_num)">
        [/if#tdec]

        ~[if#tdate.~(value_type)=DATE]
          <input type="date" name="[U_UD_VALUE]VALUE_DATE" value="~(value_date)">
        [/if#tdate]

        ~[if#tbool.~(value_type)=BOOL]
          <input type="checkbox" name="[U_UD_VALUE]VALUE_BOOL" value="1" ~[if#bc.~(value_bool)=1]checked[/if#bc]>
        [/if#tbool]

        ~[if#ttext.~(value_type)=TEXT]
          <textarea name="[U_UD_VALUE]VALUE_TEXT">~(value_text)</textarea>
        [/if#ttext]

      </div>

      ~[if#help.~(help_text)!=]
        <div class="kwe_ud_hint" style="margin-left:200px">~(help_text)</div>
      [/if#help]
    </div>
  ~[/tlist_sql]

  <div class="kwe_ud_row">
    <button class="kwe_ud_btn" type="submit">Save</button>
    <input type="hidden" name="ac" value="prim">
  </div>

</form>


</body>
</html>
