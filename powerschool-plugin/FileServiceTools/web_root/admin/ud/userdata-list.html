<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Data Records</title>
    ~[wc:commonscripts] 
    <link href="/images/css/screen.css" rel="stylesheet" media="screen">
    <link href="/images/css/print.css" rel="stylesheet" media="print">
    <style>
      .kwe_ud_btn{padding:6px 10px;border:1px solid #aaa;background:#f7f7f7;border-radius:4px;cursor:pointer;text-decoration:none;display:inline-block;margin:2px}
      .kwe_ud_btn:hover{background:#e7e7e7}
      .kwe_ud_btn_danger{border-color:#c00;color:#c00}
      .kwe_ud_btn_danger:hover{background:#ffe0e0}
      .kwe_ud_row{margin:10px 0}
      table{border-collapse:collapse;width:100%}
      th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
      th{background:#f0f0f0;text-align:left}
      .kwe_ud_right{text-align:right}
      .kwe_ud_hint{color:#666;font-size:12px}
      .pager a{margin-right:8px}
    </style>
</head>
<body>
    ~[wc:admin_header_css] 
    <a href="/" target="_top">Start Page</a> &gt; File Service Tools
    ~[wc:admin_navigation_css]

~[if#createrecord.~(gpv.action)=create]
  ~[tlist_sql;
    SELECT r.USERSDCID newusersdcid,
           r.CATEGORY_ID newcatid,
           r.ID newrecid
    FROM U_UD_RECORD r
    WHERE r.CLIENT_GUID = '~(gpv.client_guid)'
  ]
    <script>
      window.location.href = 'userdata-edit.html?usersdcid=~(newusersdcid)&catid=~(newcatid)&recid=~(newrecid)&page=1&q=';
    </script>
  [/tlist_sql]
[/if#createrecord]

<h1>User Data Records</h1>

<div class="kwe_ud_row">
  <a class="kwe_ud_btn" href="userdata-home.html">‚Üê Change User/Category</a>
  <form method="POST" style="display:inline">
    ~[DirectTable.Select:U_UD_RECORD;ID:-1]
    <input type="hidden" name="[U_UD_RECORD]USERSDCID" value="~(gpv.usersdcid)">
    <input type="hidden" name="[U_UD_RECORD]CATEGORY_ID" value="~(gpv.catid)">
    <input type="hidden" id="clientGuidField" name="[U_UD_RECORD]CLIENT_GUID" value="">
    <input type="hidden" name="[U_UD_RECORD]CREATED_BY" value="~(curUser)">
    <input type="hidden" name="ac" value="prim">
    <input type="hidden" name="usersdcid" value="~(gpv.usersdcid)">
    <input type="hidden" name="catid" value="~(gpv.catid)">
    <input type="hidden" name="page" value="~(gpv.page)">
    <input type="hidden" name="q" value="~(gpv.q)">
    <input type="hidden" id="clientGuid" name="client_guid" value="">
    <input type="hidden" name="action" value="create">
    <button type="submit" class="kwe_ud_btn">+ Add Record</button>
  </form>
</div>

<form method="GET" action="userdata-list.html" onsubmit="return prepSearch();">
  <input type="hidden" name="usersdcid" value="~(gpv.usersdcid)">
  <input type="hidden" name="catid" value="~(gpv.catid)">
  <input type="hidden" name="page" value="1">
  <label>Search:</label>
  <input type="text" id="qHuman" value="~(gpv.q)">
  <input type="hidden" name="q" id="qSql" value="~(gpv.q)">
  <button class="kwe_ud_btn" type="submit">Search</button>
  <span class="kwe_ud_hint">Use * wildcard. Example: *2025*, Toronto*</span>
</form>

<script>
function generateGuid(){
  var s4 = function(){
    return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
  };
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
}

function ensureClientGuid(){
  var guidInput = document.getElementById('clientGuid');
  var guidField = document.getElementById('clientGuidField');
  if (!guidInput || !guidField) return;
  if (!guidInput.value) {
    var guid = generateGuid();
    guidInput.value = guid;
    guidField.value = guid;
  } else if (!guidField.value) {
    guidField.value = guidInput.value;
  }
}

function prepSearch(){
  var human = document.getElementById('qHuman').value || '%';
  var sql = human.replace(/\*/g, '%');
  if(sql.trim() === '') sql = '%';
  document.getElementById('qSql').value = sql;
  return true;
}

document.addEventListener('DOMContentLoaded', function(){
  ensureClientGuid();
  var addForm = document.querySelector('.kwe_ud_row form[method="POST"]');
  if (addForm) {
    addForm.addEventListener('submit', function(){
      ensureClientGuid();
    });
  }
});
</script>

<hr>

<form method="POST" action="userdata-delete.html">
  <input type="hidden" name="usersdcid" value="~(gpv.usersdcid)">
  <input type="hidden" name="catid" value="~(gpv.catid)">
  <input type="hidden" name="page" value="~(gpv.page)">
  <input type="hidden" name="q" value="~(gpv.q)">

  <table id="recordsTable">
    <thead>
      <tr>
        <th style="width:32px"><input type="checkbox" onclick="toggleAll(this)"></th>
        <th style="width:90px">Record ID</th>
        <th style="width:140px">Created</th>
        
        <!-- Dynamic field headers - Query once -->
        ~[tlist_sql;
          SELECT f.ID fieldid,
              f.VALUE_TYPE vtype,
              NVL(f.FIELD_LABEL, f.FIELD_KEY) field_label
          FROM U_UD_FIELDDEF f
          WHERE f.CATEGORY_ID = ~(gpv.catid)
          ORDER BY NVL(f.SORT_ORDER, 9999), UPPER(f.FIELD_LABEL)
        ]
          <th data-fieldid="~(fieldid)" data-vtype="~(vtype)">~(field_label)</th>
        [/tlist_sql]
        
        <th style="width:140px" class="kwe_ud_right">Actions</th>
      </tr>
    </thead>
    <tbody>
      ~[tlist_sql;
        SELECT LISTAGG(
          r.ID || '|' || r.CREATED_ON || '|' || r.USERSDCID || '|' || r.CATEGORY_ID || '|' ||
          (
            SELECT LISTAGG(
              REPLACE(
                REPLACE(
                  REPLACE(
                    REPLACE(
                      CASE f.VALUE_TYPE
                        WHEN 'TEXT' THEN NVL(DBMS_LOB.SUBSTR(v.VALUE_TEXT, 4000, 1), '')
                        WHEN 'BOOL' THEN NVL(TO_CHAR(v.VALUE_BOOL), '')
                        WHEN 'INT' THEN NVL(TO_CHAR(v.VALUE_NUM), '')
                        WHEN 'DECIMAL' THEN NVL(TO_CHAR(v.VALUE_NUM), '')
                        WHEN 'DATE' THEN NVL(TO_CHAR(v.VALUE_DATE, 'YYYY-MM-DD'), '')
                        ELSE NVL(v.VALUE_STR, '')
                      END,
                      '&', '&amp;'
                    ),
                    '"', '&quot;'
                  ),
                  '<', '&lt;'
                ),
                '~DELIM~', '~_DELIM_~'
              ), '~DELIM~'
            ) WITHIN GROUP (ORDER BY NVL(f.SORT_ORDER, 9999), UPPER(f.FIELD_LABEL))
            FROM U_UD_FIELDDEF f
            LEFT JOIN U_UD_VALUE v ON v.FIELDDEF_ID = f.ID AND v.RECORD_ID = r.ID
            WHERE f.CATEGORY_ID = r.CATEGORY_ID
          ),
          '|||'
        ) WITHIN GROUP (ORDER BY r.CREATED_ON DESC, r.ID DESC) all_records
        FROM U_UD_RECORD r
        WHERE r.USERSDCID = ~(gpv.usersdcid)
          AND r.CATEGORY_ID = ~(gpv.catid)
      ]
      <tr style="display:none;" id="recordsData" data-records="~(all_records)"></tr>
      [/tlist_sql]
    </tbody>
  </table>

  <div class="kwe_ud_row">
    <button class="kwe_ud_btn kwe_ud_btn_danger" type="submit">Delete Selected</button>
    <span class="kwe_ud_hint">Deletes record + its values (handled in userdata-delete.html)</span>
  </div>
</form>

<!-- Simple pager links -->
~[tlist_sql;
  SELECT
    CASE WHEN NVL(~(gpv.page),1) - 1 < 1 THEN 1 ELSE NVL(~(gpv.page),1) - 1 END prev_page,
    NVL(~(gpv.page),1) + 1 next_page,
    NVL(~(gpv.page),1) curr_page
  FROM DUAL
]
<div class="pager">
  <a class="kwe_ud_btn" href="userdata-list.html?usersdcid=~(gpv.usersdcid)&catid=~(gpv.catid)&page=~(prev_page)&q=~(gpv.q)">Prev</a>
  <a class="kwe_ud_btn" href="userdata-list.html?usersdcid=~(gpv.usersdcid)&catid=~(gpv.catid)&page=~(next_page)&q=~(gpv.q)">Next</a>
  <span class="kwe_ud_hint">Page: ~(curr_page)</span>
</div>
[/tlist_sql]

<script>
function renderRecordsFromData(){
  var recordsEl = document.getElementById('recordsData');
  if(!recordsEl) return;
  var allRecordsStr = recordsEl.getAttribute('data-records') || '';
  if(!allRecordsStr) return;
  
  var records = allRecordsStr.split('|||');
  var tbody = recordsEl.parentNode;
  
  for(var i = 0; i < records.length; i++){
    var parts = records[i].split('|');
    if(parts.length < 5) continue;
    var recid = parts[0], created = parts[1], usersdcid = parts[2], catid = parts[3];
    var valuesConcat = parts.slice(4).join('|');
    
    var tr = document.createElement('tr');
    tr.setAttribute('data-values', valuesConcat);
    tr.innerHTML = 
      '<td><input type="checkbox" name="del_recid" value="' + recid + '"></td>' +
      '<td>' + recid + '</td>' +
      '<td>' + created + '</td>' +
      '<td class="kwe_ud_values" data-values="' + valuesConcat + '"></td>' +
      '<td class="kwe_ud_right">' +
        '<a class="kwe_ud_btn" href="userdata-edit.html?usersdcid=' + usersdcid + '&catid=' + catid + '&recid=' + recid + '&page=~(gpv.page)&q=~(gpv.q)">Edit</a> ' +
        '<a class="kwe_ud_btn kwe_ud_btn_danger" onclick="return confirm(\'Delete this record?\');" href="userdata-delete.html?usersdcid=' + usersdcid + '&catid=' + catid + '&recid=' + recid + '&page=~(gpv.page)&q=~(gpv.q)">Delete</a>' +
      '</td>';
    tbody.appendChild(tr);
  }
}

function toggleAll(master){
  var cbs = document.querySelectorAll('input[name="del_recid"]');
  for(var i=0;i<cbs.length;i++) cbs[i].checked = master.checked;
}

function renderValueCells(){
  var headerCount = document.querySelectorAll('#recordsTable thead th[data-fieldid]').length;
  var rows = document.querySelectorAll('#recordsTable tbody tr');
  for (var i = 0; i < rows.length; i++) {
    var marker = rows[i].querySelector('td.kwe_ud_values');
    if (!marker) continue;
    var raw = marker.getAttribute('data-values') || '';
    var values = raw ? raw.split('~DELIM~') : [];
    while (values.length < headerCount) values.push('');
    for (var v = 0; v < headerCount; v++) {
      var td = document.createElement('td');
      td.textContent = values[v] || '';
      rows[i].insertBefore(td, marker);
    }
    marker.parentNode.removeChild(marker);
  }
}

document.addEventListener('DOMContentLoaded', function(){
  renderRecordsFromData();
  renderValueCells();
});
</script>


</body>
</html>
