<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Staging Tools - File Service</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; color: #222; }
    h1 { margin: 0 0 12px; }
    fieldset { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    legend { font-weight: 600; }
    label { display: inline-block; margin-right: 12px; }
    input[type="text"] { width: 360px; padding: 6px 8px; border: 1px solid #ccc; border-radius: 6px; }
    input[type="file"] { padding: 6px 0; }
    button { padding: 8px 12px; border: 1px solid #0078d4; background: #0078d4; color: #fff; border-radius: 6px; cursor: pointer; }
    button.secondary { border-color: #555; background: #fff; color: #222; }
    button + button { margin-left: 8px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .muted { color: #666; }
    .progress { height: 10px; background: #eee; border-radius: 6px; overflow: hidden; margin-top: 8px; }
    .bar { height: 100%; background: #28a745; width: 0%; transition: width 0.1s linear; }
    .stats { margin-top: 6px; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    th { background: #f7f7f7; }
    .right { text-align: right; }
    .danger { background: #c62828; border-color: #c62828; }
    .success { color: #1b5e20; }
    .error { color: #b00020; }
    .hidden { display: none; }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <h1>Staging Tools</h1>
  <p class="muted small">Calls the staging environment APIs directly. Provide PowerSchool user & role headers to authenticate.</p>

  <fieldset>
    <legend>Environment & Auth</legend>
    <div class="row">
      <label>
        Base URL
        <input id="baseUrl" type="text" value="https://filesvc-stg-app.chinacloudsites.cn" />
      </label>
      <label>
        X-PowerSchool-User
        <input id="psUser" type="text" placeholder="e.g. admin1" />
      </label>
      <label>
        X-PowerSchool-Role
        <input id="psRole" type="text" value="admin" />
      </label>
      <label>
        <input id="includeAll" type="checkbox" checked /> Include all users (admin only)
      </label>
    </div>
    <div class="small muted">Ensure your app’s CORS allows this page’s origin. If loading from file://, some browsers restrict requests; prefer serving via a local HTTP server.</div>
  </fieldset>

  <fieldset>
    <legend>Upload Files</legend>
    <div class="row">
      <input id="singleFile" type="file" />
      <button id="btnUploadSingle">Upload One</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <input id="multiFiles" type="file" multiple />
      <button id="btnUploadMulti">Upload Multiple</button>
      <button id="btnCancelUploads" class="secondary">Cancel</button>
    </div>
    <div class="progress"><div id="progressBar" class="bar"></div></div>
    <div id="progressStats" class="stats muted">Idle</div>
    <div id="uploadStatus" class="small"></div>
  </fieldset>

  <fieldset>
    <legend>Files</legend>
    <div class="row">
      <button id="btnRefresh">Refresh List</button>
      <button id="btnDeleteSelected" class="danger">Delete Selected</button>
    </div>
    <table id="filesTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="checkAll" /></th>
          <th>File Name</th>
          <th>Content Type</th>
          <th class="right">Size</th>
          <th>Owner</th>
          <th>Uploaded At</th>
          <th>Id</th>
        </tr>
      </thead>
      <tbody id="filesBody"></tbody>
    </table>
    <div id="listStatus" class="small"></div>
  </fieldset>

  <script>
    const el = id => document.getElementById(id);

    const state = {
      abortController: null,
      totalBytes: 0,
      uploadedBytes: 0,
      startTime: 0,
      lastUpdateTime: 0,
      lastUploadedBytes: 0,
    };

    function headers() {
      const h = new Headers();
      const user = el('psUser').value.trim();
      const role = el('psRole').value.trim();
      if (user) h.set('X-PowerSchool-User', user);
      if (role) h.set('X-PowerSchool-Role', role);
      return h;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024, sizes = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return `${(bytes / Math.pow(k, i)).toFixed(2)} ${sizes[i]}`;
    }

    function setProgress(percent, speedBps) {
      const pct = Math.max(0, Math.min(100, percent));
      el('progressBar').style.width = pct + '%';
      const speed = speedBps ? `${formatBytes(speedBps)}/s` : '—';
      const stats = `Progress: ${pct.toFixed(1)}% • Speed: ${speed} • ${formatBytes(state.uploadedBytes)} / ${formatBytes(state.totalBytes)}`;
      el('progressStats').textContent = stats;
    }

    function resetProgress() {
      state.totalBytes = 0;
      state.uploadedBytes = 0;
      state.startTime = 0;
      state.lastUpdateTime = 0;
      state.lastUploadedBytes = 0;
      setProgress(0, 0);
      el('uploadStatus').textContent = '';
    }

    function xhrUpload(file, baseUrl) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        const url = `${baseUrl}/api/files/upload`;
        xhr.open('POST', url);
        // Add headers
        headers().forEach((v, k) => xhr.setRequestHeader(k, v));

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const now = performance.now();
            state.uploadedBytes += (e.loaded - state.lastUploadedBytes);
            state.lastUploadedBytes = e.loaded;
            const elapsedMs = now - state.startTime;
            const speed = elapsedMs > 0 ? (state.uploadedBytes / (elapsedMs / 1000)) : 0;
            const percent = state.totalBytes > 0 ? (state.uploadedBytes / state.totalBytes) * 100 : 0;
            setProgress(percent, speed);
          }
        };

        xhr.onreadystatechange = () => {
          if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300) {
              resolve(xhr.responseText || 'OK');
            } else {
              const body = xhr.responseText ? ` | ${xhr.responseText}` : '';
              reject(new Error(`Upload failed: ${xhr.status} ${xhr.statusText}${body}`));
            }
          }
        };

        xhr.onerror = () => reject(new Error('Network error during upload'));
        xhr.onabort = () => reject(new Error('Upload aborted'));

        const form = new FormData();
        form.append('file', file, file.name);
        xhr.send(form);
      });
    }

    async function uploadSingle() {
      resetProgress();
      const baseUrl = el('baseUrl').value.trim();
      const file = el('singleFile').files[0];
      if (!file) { el('uploadStatus').textContent = 'Please choose a file.'; return; }

      state.totalBytes = file.size;
      state.startTime = performance.now();
      state.lastUploadedBytes = 0;
      try {
        await xhrUpload(file, baseUrl);
        setProgress(100, 0);
        el('uploadStatus').innerHTML = '<span class="success">Upload complete.</span>';
        await refreshList();
      } catch (err) {
        el('uploadStatus').innerHTML = `<span class="error">${err.message}</span>`;
      }
    }

    async function uploadMultiple() {
      resetProgress();
      const baseUrl = el('baseUrl').value.trim();
      const files = Array.from(el('multiFiles').files || []);
      if (files.length === 0) { el('uploadStatus').textContent = 'Please choose files.'; return; }

      state.totalBytes = files.reduce((sum, f) => sum + f.size, 0);
      state.startTime = performance.now();
      try {
        for (const file of files) {
          state.lastUploadedBytes = 0; // per-file progress baseline
          await xhrUpload(file, baseUrl);
        }
        setProgress(100, 0);
        el('uploadStatus').innerHTML = `<span class="success">Uploaded ${files.length} files.</span>`;
        await refreshList();
      } catch (err) {
        el('uploadStatus').innerHTML = `<span class="error">${err.message}</span>`;
      }
    }

    async function refreshList() {
      const baseUrl = el('baseUrl').value.trim();
      const includeAll = el('includeAll').checked;
      const url = `${baseUrl}/api/files${includeAll ? '?all=true' : ''}`;
      el('listStatus').textContent = 'Loading...';
      try {
        const res = await fetch(url, { headers: headers(), mode: 'cors' });
        if (!res.ok) throw new Error(`List failed: ${res.status}`);
        const data = await res.json();
        renderList(Array.isArray(data) ? data : []);
        el('listStatus').textContent = `Loaded ${Array.isArray(data) ? data.length : 0} items.`;
      } catch (err) {
        el('listStatus').innerHTML = `<span class="error">${err.message}</span>`;
      }
    }

    function renderList(items) {
      const tbody = el('filesBody');
      tbody.innerHTML = '';
      for (const item of items) {
        const tr = document.createElement('tr');
        const size = item.SizeBytes ?? item.sizeBytes ?? item.Size ?? 0;
        const uploadedAt = item.UploadedAt ?? item.uploadedAt ?? item.CreatedAt ?? '';
        const owner = item.OwnerUserId ?? item.ownerUserId ?? item.CreatedBy ?? '';
        const id = item.Id ?? item.id ?? '';
        const name = item.FileName ?? item.fileName ?? '';
        const ct = item.ContentType ?? item.contentType ?? '';

        tr.innerHTML = `
          <td><input type="checkbox" class="rowCheck" data-id="${id}" /></td>
          <td>${name}</td>
          <td>${ct}</td>
          <td class="right">${formatBytes(Number(size) || 0)}</td>
          <td>${owner}</td>
          <td>${uploadedAt ? new Date(uploadedAt).toLocaleString() : ''}</td>
          <td class="small">${id}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function deleteSelected() {
      const baseUrl = el('baseUrl').value.trim();
      const checks = Array.from(document.querySelectorAll('.rowCheck:checked'));
      if (checks.length === 0) { el('listStatus').textContent = 'No files selected.'; return; }
      el('listStatus').textContent = `Deleting ${checks.length} files...`;
      let ok = 0, fail = 0;
      for (const c of checks) {
        const id = c.getAttribute('data-id');
        try {
          const res = await fetch(`${baseUrl}/api/files/${id}`, { method: 'DELETE', headers: headers(), mode: 'cors' });
          if (res.ok) ok++; else fail++;
        } catch { fail++; }
      }
      el('listStatus').textContent = `Deleted ${ok}, failed ${fail}.`;
      await refreshList();
    }

    // Check all toggle
    el('checkAll').addEventListener('change', (e) => {
      const checked = e.target.checked;
      document.querySelectorAll('.rowCheck').forEach(cb => cb.checked = checked);
    });

    // Wire buttons
    el('btnUploadSingle').addEventListener('click', uploadSingle);
    el('btnUploadMulti').addEventListener('click', uploadMultiple);
    el('btnRefresh').addEventListener('click', refreshList);
    el('btnDeleteSelected').addEventListener('click', deleteSelected);

    // Initial list
    // Optionally auto-load list on page ready
    // refreshList();
  </script>
</body>
</html>
